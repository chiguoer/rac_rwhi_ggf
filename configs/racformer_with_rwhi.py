# =================================================================
# [TRAINING WARNING - RWHI 30m 双流初始化]
# =================================================================
# 1. DO NOT resume from previous checkpoints.
# 2. 使用 30m 分界双流：
#    - num_safety = 300 (0-30m 逆深度固定锚点)
#    - num_saliency = 600 (>30m 雷达驱动锚点)
# 3. num_query = num_safety + num_saliency = 900
# =================================================================

# ============================================================
# RaCFormer 配置文件 - RWHI 30m 双流策略
# ============================================================
# RWHI 30m 双流（Safety/Saliency）
# - Safety Stream: 0-30m 逆深度固定锚点
# - Saliency Stream: >30m 雷达驱动 + TopK
#
# 使用方法：
#   训练：python train.py --config configs/racformer_with_rwhi.py
#   测试：python val.py --config configs/racformer_with_rwhi.py --weights checkpoints/xxx.pth
# ============================================================

# 继承基础配置
_base_ = './racformer_r50_nuimg_704x256_f8.py'

# ============================================================
# RWHI 模块配置 - 30m 双流策略
# ============================================================
rwhi_cfg = dict(
    # ============================================================
    # 30m 分界双流
    # ============================================================
    num_safety=300,              # 0-30m 固定锚点
    num_saliency=600,            # >30m 雷达驱动锚点
    
    # ============================================================
    # 空间范围 - 全图覆盖
    # ============================================================
    max_range=55.0,
    min_range=2.0,
    safety_max_range=30.0,
    
    # ============================================================
    # RCS过滤阈值
    # ============================================================
    rcs_threshold=0.0,
    rcs_noise=0.0,
    rcs_clip=10.0,
    
    # ============================================================
    # BEV网格配置
    # ============================================================
    bev_grid_size=100,           # BEV网格分辨率 (100x100)
    
    # ============================================================
    # 权重计算
    # ============================================================
    dist_ref=30.0,
    dist_gamma=1.0,
    vel_beta=0.0,
    vel_threshold=0.0,
    vel_scale=1.0,
    
    # ============================================================
    # 高度假设 - 简化为单高度以节省预算
    # ============================================================
    height_hypotheses=(0.5,),    # 单一中间高度
    # 注意: 使用单高度确保300个雷达锚点全部用于XY位置
    #       而不是分散到多个高度假设
    
    # ============================================================
    # 不确定性扩散
    # ============================================================
    diffusion_kernel_size=3,
    
    # ============================================================
    # TopK防重复噪声
    # ============================================================
    noise_eps_train=1e-6,
    noise_eps_test=0.0,
    
    # ============================================================
    # 远场最小密度参数
    # ============================================================
    radar_channel_map=dict(x=0, y=1, z=2, rcs=3, v_r=4),
    
    # ============================================================
    # 总开关
    # ============================================================
    enabled=True,
)

# ============================================================
# 模型配置 - 启用RWHI v2.1 预算膨胀
# ============================================================
model = dict(
    pts_bbox_head=dict(
        # ============================================================
        # 30m 双流: num_query = num_safety + num_saliency
        # ============================================================
        num_query=900,
        
        # 启用RWHI Query初始化
        use_rwhi=True,
        rwhi_cfg=rwhi_cfg,
    ),
)

# ============================================================
# DDP训练配置
# ============================================================
dist_params = dict(backend='nccl', find_unused_parameters=True)
find_unused_parameters = True

# ============================================================
# v2.1 预算膨胀策略说明
# ============================================================
#
# 【为什么v2.0性能不如基线？】
# - v2.0: num_base=500, 基础密度下降 (900-500)/900 = 44%
# - 远场目标的召回率下降，因为锚点不够密集
#
# 【v2.1的解决方案: 预算膨胀】
# - num_base = 900: 完全匹配基线的空间密度
# - num_radar = 300: 纯增益，不占用基础预算
# - 结果: 基础覆盖 ≥ 基线，额外雷达增益 = 纯收益
#
# 【显存影响】
# - Query数量从900增加到1200 (+33%)
# - Transformer计算量略有增加
# - 如果显存不足，可以减少num_radar到200
#
# 【可选调整】
# - 激进模式: num_base=900, num_radar=450 (num_query=1350)
# - 保守模式: num_base=900, num_radar=200 (num_query=1100)
# ============================================================

# ============================================================
# 版本演进对照表
# ============================================================
# | 版本  | num_query | num_base | num_radar | 问题/改进           |
# |-------|-----------|----------|-----------|---------------------|
# | 基线  | 900       | 900      | 0         | 无雷达增益          |
# | v2.0  | 900       | 500      | 400       | 基础密度下降44%     |
# | v2.1  | 1200      | 900      | 300       | 匹配基线+纯雷达增益 |
# ============================================================
